
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="计算机图形学概论(graphicsbook)">
      
      
      
        <link rel="canonical" href="https://hellowac.github.io/graphicsbook-zh-cn/cn/c9/s4/">
      
      
        <link rel="prev" href="../s3/">
      
      
        <link rel="next" href="../s5/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.28">
    
    
      
        <title>9.4 WebGPU 中的 3D 图形 - 计算机图形学概论</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.6543a935.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      

  
  
  
  
  <style>:root{--md-annotation-icon:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M22 12a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M6 13h8l-3.5 3.5 1.42 1.42L17.84 12l-5.92-5.92L10.5 7.5 14 11H6v2Z"/></svg>');}</style>


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
   <link href="../../../assets/stylesheets/glightbox.min.css" rel="stylesheet"/><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style> <script src="../../../assets/javascripts/glightbox.min.js"></script></head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="default" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#94-webgpu-中的-3d-图形" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../../.." title="计算机图形学概论" class="md-header__button md-logo" aria-label="计算机图形学概论" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            计算机图形学概论
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              9.4 WebGPU 中的 3D 图形
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="选择当前语言">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.52 17.52 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04M18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12m-2.62 7 1.62-4.33L19.12 17h-3.24Z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="/graphicsbook-zh-cn/en/" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="/graphicsbook-zh-cn/cn/" hreflang="cn" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/hellowac/graphicsbook-zh-cn" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    graphicsbook
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        
  
    
  
  首页

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../preface/" class="md-tabs__link">
        
  
    
  
  前言

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c1/" class="md-tabs__link">
          
  
    
  
  1.简介

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c2/" class="md-tabs__link">
          
  
    
  
  2.二维图形

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c3/" class="md-tabs__link">
          
  
    
  
  3.几何

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c4/" class="md-tabs__link">
          
  
    
  
  4.灯光和材质

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c5/" class="md-tabs__link">
          
  
    
  
  5.three.js

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c6/" class="md-tabs__link">
          
  
    
  
  6.WebGL

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c7/" class="md-tabs__link">
          
  
    
  
  7.WebGL 3D

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../c8/" class="md-tabs__link">
          
  
    
  
  8.高阶3D

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../" class="md-tabs__link">
          
  
    
  
  9.WEBGPU

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../a1/" class="md-tabs__link">
          
  
    
  
  附录A

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../a2/" class="md-tabs__link">
          
  
    
  
  附录B

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../a3/" class="md-tabs__link">
          
  
    
  
  附录C

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../source/" class="md-tabs__link">
          
  
    
  
  附录D

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../glossary/" class="md-tabs__link">
          
  
    
  
  术语表

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
    
  
  关于

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="计算机图形学概论" class="md-nav__button md-logo" aria-label="计算机图形学概论" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    计算机图形学概论
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/hellowac/graphicsbook-zh-cn" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    graphicsbook
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../preface/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    前言
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c1/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    1.简介
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_3" id="__nav_3_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            1.简介
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c1/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第 1 节 绘画与绘图
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c1/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第 2 节：三维(3D)图形的要素
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c1/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第 3 节：硬件与软件
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c2/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    2.二维图形
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_4" id="__nav_4_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            2.二维图形
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c2/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第1节: 像素、坐标和颜色
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c2/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第2节: 形状
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c2/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第3节: 变换
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c2/s4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第4节: 分层建模
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c2/s5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第5节: Java 绘制2D
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c2/s6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第6节: HTML Canvas图形
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c2/s7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    第7节: SVG：一种场景描述语言
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c3/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    3.几何
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_5" id="__nav_5_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            3.几何
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c3/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.1 OpenGL 1.1 中的形状和颜色
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c3/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.2 3D 坐标和变换
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c3/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.3 投影与观看
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c3/s4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.4 多边形网格和 glDrawArrays
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c3/s5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.5 部分线性代数基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c3/s6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    3.6 使用 GLUT 和 JOGL
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c4/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    4.灯光和材质
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_6" id="__nav_6_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            4.灯光和材质
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c4/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.1 照明简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c4/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.2 OpenGL 1.1 中的光和材质
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c4/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.3 图像纹理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c4/s4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    4.4 灯光、相机、动作
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c5/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    5.three.js
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_7" id="__nav_7_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            5.three.js
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c5/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.1 Three.js 基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c5/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.2 构建对象
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c5/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    5.3 其他功能
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c6/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    6.WebGL
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_8" id="__nav_8_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            6.WebGL
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c6/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.1 可编程流水线
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c6/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.2 第一个例子
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c6/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.3 GLSL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c6/s4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.4 图像纹理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c6/s5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    6.5 实现 2D 变换
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c7/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    7.WebGL 3D
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_9" id="__nav_9_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            7.WebGL 3D
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c7/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.1 3D变换
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c7/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.2 照明和材质
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c7/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.3 纹理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c7/s4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.4 帧缓冲区
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c7/s5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    7.5 WebGL 扩展
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_10" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../c8/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    8.高阶3D
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_10" id="__nav_10_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            8.高阶3D
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c8/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8.1 光线追踪
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../c8/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    8.2 路径追踪
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_11" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    9.WEBGPU
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_11" id="__nav_11_label" tabindex="">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_11_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_11">
            <span class="md-nav__icon md-icon"></span>
            9.WEBGPU
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.1 WebGPU 基础
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.2 实例和索引
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.3 WGSL
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    9.4 WebGPU 中的 3D 图形
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    9.4 WebGPU 中的 3D 图形
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#941-深度测试" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.1 深度测试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#942-坐标系" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.2 坐标系
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#943-进入-3d" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.3 进入 3D
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#944-wgpu-矩阵" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.4 wgpu 矩阵
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#945-再次磁盘世界" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.5 再次磁盘世界
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.5 纹理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s6/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.6 计算着色器
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../s7/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    9.7 细节
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_12" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../a1/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    附录A
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_12" id="__nav_12_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_12_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_12">
            <span class="md-nav__icon md-icon"></span>
            附录A
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a1/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A.1 Java 编程语言
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a1/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A.2 C 编程语言
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a1/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A.3 JavaScript 编程语言
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a1/s4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    A.4 JavaScript Promise 和异步函数
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_13" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../a2/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    附录B
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_13" id="__nav_13_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_13_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_13">
            <span class="md-nav__icon md-icon"></span>
            附录B
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B.1 节 Blender 基础知识
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2/s2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B.2 节 Blender 建模
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2/s3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B.3 节 Blender 动画
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a2/s4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    B.4 节 有关光和材料的更多信息
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_14" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../a3/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    附录C
  </span>
  

            </a>
            
              
              <label class="md-nav__link " for="__nav_14" id="__nav_14_label" tabindex="0">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_14_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_14">
            <span class="md-nav__icon md-icon"></span>
            附录C
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../a3/s1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    C.1 节 Gimp：2D 绘画程序
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
          
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_15" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../source/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    附录D
  </span>
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_15_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_15">
            <span class="md-nav__icon md-icon"></span>
            附录D
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
      
        
      
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_16" >
        
          
          <label class="md-nav__link" for="__nav_16" id="__nav_16_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    术语表
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_16_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_16">
            <span class="md-nav__icon md-icon"></span>
            术语表
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    术语表
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    关于
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#941-深度测试" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.1 深度测试
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#942-坐标系" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.2 坐标系
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#943-进入-3d" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.3 进入 3D
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#944-wgpu-矩阵" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.4 wgpu 矩阵
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#945-再次磁盘世界" class="md-nav__link">
    <span class="md-ellipsis">
      9.4.5 再次磁盘世界
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="94-webgpu-中的-3d-图形">9.4 <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> 中的 3D 图形<a class="headerlink" href="#94-webgpu-中的-3d-图形" title="Permanent link">&para;</a></h1>
<p><strong>3D Graphics With <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr></strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="__tabbed_1_1">中文</label><label for="__tabbed_1_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>到目前为止，我们的WebGPU示例都是二维的，但当然计算机图形学的主要兴趣在于渲染三维场景。这意味着使用三维坐标系、几何变换以及光照和材质。我们将在本节中看到所有这些内容。但请注意，我们将只使用基本的OpenGL光照模型，而不是已经变得更加常见的更现实的基于物理的渲染。本节的最后一个示例将是我简单的WebGL "<a href="../../../en/source/webgl/diskworld-2.html">diskworld</a>" 层次建模示例的移植。这是WebGPU版本的演示：<a href="../../../en/source/webgpu/diskworld.html">diskworld <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> Demo</a>。</p>
<p><iframe src="../../../en/demos/c9/diskworld-webgpu-demo.html" width="475" height="575"></iframe></p>
</div>
<div class="tabbed-block">
<p>So far, our <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> examples have been two-dimensional, but of course the main interest in computer graphics is in <abbr title="The process of producing a 2D image from a 3D scene description.">rendering</abbr> three-dimensional scenes. That means using 3D <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate systems</abbr>, geometric transformations, and <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> and <abbr title="The properties of an object that determine how that object interacts with light in the environment. Material properties in OpenGL include, for example, diffuse color, specular color, and shininess.">material</abbr>. We will look at all that in this section. But note that we will use only the basic <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr> <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> model, not the more realistic physically based <abbr title="The process of producing a 2D image from a 3D scene description.">rendering</abbr> that has become more common. The last example in the section will be a port of my simple <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr> "<a href="../../../en/source/webgl/diskworld-2.html">diskworld</a>" <abbr title="Creating complex geometric models in a hierarchical fashion, starting with geometric primitives, combining them into components that can then be further combined into more complex components, and so on.">hierarchical modeling</abbr> example. Here is a demo of the <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> version:</p>
<p><iframe src="../../../en/demos/c9/diskworld-webgpu-demo.html" width="475" height="575"></iframe></p>
</div>
</div>
</div>
<h2 id="941-深度测试">9.4.1 <abbr title="解决隐藏表面问题的一种方法，涉及跟踪图像中每个像素点当前可见对象的深度，即与观察者的距离。当在像素点处绘制新对象时，将新对象的深度与当前对象的深度进行比较，以决定哪个对象更靠近观察者。深度测试的优点是对象可以以任何顺序渲染。缺点是图像中只能表示有限范围的深度。">深度测试</abbr><a class="headerlink" href="#941-深度测试" title="Permanent link">&para;</a></h2>
<p><strong>The Depth Test</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="__tabbed_2_1">中文</label><label for="__tabbed_2_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>在我们进入3D之前，我们需要知道如何在WebGPU中实现深度测试。深度测试用于确保位于其他对象后面的对象实际上被这些前景对象隐藏起来。（见<a href="../../c3/s1/#314-深度测试">3.1.4小节</a>。）与OpenGL不同，这不仅仅是启用测试的问题。您还必须提供用于保存图像中像素深度信息的深度缓冲区，并且您必须将该缓冲区附加到渲染管线。</p>
<p>示例程序 <a href="../../../en/source/webgpu/depth_test.html">webgpu/depth_test.html</a> 在一个2D场景中使用深度测试，绘制了五十个带有黑色轮廓的彩色圆盘。所有圆盘和轮廓都是在绘制之前完成的。着色器程序为每个圆盘和轮廓应用了不同的深度，以确保即使它们不是按顺序绘制的，圆盘和轮廓也遵循正确的前到后的顺序。详情请参阅源代码，并注意只有与深度测试相关的源代码部分有注释。</p>
<p>WebGPU中的深度缓冲区实际上是一个纹理，与图像大小相同。可以使用 <code>device.createTexture()</code> 函数创建它：</p>
<div class="highlight"><pre><span></span><code><span class="nx">depthTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">device</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">({</span>
<span class="w">    </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">],</span><span class="w">  </span><span class="c1">// 画布大小</span>
<span class="w">    </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;depth24plus&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nx">GPUTextureUsage</span><span class="p">.</span><span class="nx">RENDER_ATTACHMENT</span>
<span class="p">});</span>
</code></pre></div>
<p>这里的 depthTexture 是一个全局变量，因为纹理是在初始化期间创建一次，但它将在每次绘制图像时使用。纹理的格式描述了每个像素存储的数据。这里使用的值 "depth24plus" 表示纹理每个像素至少持有24位深度信息。使用方式表示此纹理可以附加到渲染管线。</p>
<p>创建管线时，必须通过在 device.createRenderPipeline() 函数中使用的管线描述符中添加 depthStencil 属性来启用深度测试：</p>
<div class="highlight"><pre><span></span><code><span class="nx">depthStencil</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 为此管线启用深度测试</span>
<span class="w">    </span><span class="nx">depthWriteEnabled</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nx">depthCompare</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;less&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;depth24plus&quot;</span><span class="p">,</span>
<span class="p">},</span>
</code></pre></div>
<p>这里的格式应与创建纹理时指定的格式匹配。depthWriteEnabled 和 depthCompare 的值可能如上所示。（深度测试通过比较新片段的深度值与当前存储在深度缓冲区的深度值来工作。如果比较结果为假，则丢弃新片段。depthCompare 属性指定应用的比较运算符。使用 "less" 意味着如果片段的深度小于当前深度，则使用该片段；也就是说，深度较低的项目被认为更接近用户。在某些情况下，"less-equal" 可能是该属性的更好值。将 depthWriteEnabled 属性设置为 true 意味着当新片段通过深度测试时，其深度值将写入深度缓冲区。在某些应用程序中，可能需要应用深度测试而不保存新的深度值。这有时是完成的，例如，在绘制半透明对象时（见 <a href="../../c7/s4/#741-帧缓冲区操作">7.4.1小节</a>)。）</p>
<p>最后，在绘制图像时，深度缓冲区必须作为渲染通道描述符的一部分附加到管线：</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="nx">renderPassDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">colorAttachments</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">        </span><span class="nx">clearValue</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="nx">loadOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clear&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="nx">storeOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">view</span><span class="o">:</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">getCurrentTexture</span><span class="p">().</span><span class="nx">createView</span><span class="p">()</span>
<span class="w">    </span><span class="p">}],</span>
<span class="w">    </span><span class="nx">depthStencilAttachment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 将深度缓冲区添加到 colorAttachment</span>
<span class="w">        </span><span class="nx">view</span><span class="o">:</span><span class="w"> </span><span class="nx">depthTexture</span><span class="p">.</span><span class="nx">createView</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">depthClearValue</span><span class="o">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">depthLoadOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clear&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">depthStoreOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>请注意，depthStencilAttachment 中的 view 是之前创建的 depthTexture 的视图。depthClearValue 表示在清除深度缓冲区时，每个片段的深度将初始化为 1.0。1.0 是可能的最大深度值，表示深度位于图像中其他任何东西的后面。（顺便说一下，这里的 "Stencil" 指的是模板测试，本教科书中没有涵盖；模板测试的内存通常与深度测试的内存结合在一起，在WebGPU中它们将是同一纹理的一部分。）</p>
<p>renderPassDescriptor 中的 "clear" 属性意味着在渲染任何内容之前，颜色和深度缓冲区将用清除值填充。这适用于第一次渲染通道。但是，对于任何额外的渲染通道，为了避免擦除已经绘制的内容，"clear" 必须更改为 "load"。例如，示例程序在第二次渲染通道之前进行此更改：</p>
<div class="highlight"><pre><span></span><code><span class="nx">renderPassDescriptor</span><span class="p">.</span><span class="nx">depthStencilAttachment</span><span class="p">.</span><span class="nx">depthLoadOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;load&quot;</span><span class="p">;</span>
<span class="nx">renderPassDescriptor</span><span class="p">.</span><span class="nx">colorAttachments</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">loadOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;load&quot;</span><span class="p">;</span>
</code></pre></div>
<hr />
<p>实际上，示例程序使用了多重采样（<a href="../s2/#925-多重采样">9.2.5小节</a>），这在创建深度纹理时需要一个小的更改：</p>
<div class="highlight"><pre><span></span><code><span class="nx">depthTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">device</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">({</span>
<span class="w">    </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">],</span>
<span class="w">    </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;depth24plus&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sampleCount</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// 使用多重采样时必需！</span>
<span class="w">    </span><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nx">GPUTextureUsage</span><span class="p">.</span><span class="nx">RENDER_ATTACHMENT</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
</div>
<div class="tabbed-block">
<p>Before we enter 3D, we need to know how to implement the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> in <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr>. The <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> is used to make sure that objects that lie behind other objects are actually hidden by those foreground objects. (See <a href="../../c3/s1/#314--深度测试">Subsection 3.1.4</a>.) Unlike in <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr>, it is not simply a matter of enabling the test. You also have to provide the <abbr title="A region of memory that stores the information needed for the depth test in 3D graphics, that is, a depth value for each pixel in the image. Also called the &quot;z-buffer.&quot;">depth buffer</abbr> that is used to hold depth information about <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixels</abbr> in the image, and you have to attach that buffer to the <abbr title="The process of producing a 2D image from a 3D scene description.">rendering</abbr> <abbr title="A sequence of computational stages in a GPU that are applied to incoming data to produce some result. Some of the stages can be programmable shaders, such as vertex shaders, fragment shaders, and compute shaders. In a graphics rendering pipeline, the output is the colors of the pixels in an image.">pipeline</abbr>.</p>
<p>The sample program <a href="../../../en/source/webgpu/depth_test.html">webgpu/depth_test.html</a> uses the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> in a 2D scene that draws fifty colored disks with black outlines. All of the disks are drawn before all of the outlines. The <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> programs apply a different depth to each disk and to each outline to ensure that the disks and outlines are seen to follow the correct back-to-front order, even though they are not drawn in that order. See the source code for details, and note that only the parts of the source code that have to do with the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> are commented.</p>
<p>The <abbr title="A region of memory that stores the information needed for the depth test in 3D graphics, that is, a depth value for each pixel in the image. Also called the &quot;z-buffer.&quot;">depth buffer</abbr> in <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> is actually a kind of <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr>, with the same size as the image. It can be created using the <code>device.createTexture()</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="nx">depthTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">device</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">({</span>
<span class="w">    </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">],</span><span class="w">  </span><span class="c1">// size of canvas</span>
<span class="w">    </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;depth24plus&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nx">GPUTextureUsage</span><span class="p">.</span><span class="nx">RENDER_ATTACHMENT</span>
<span class="p">});</span>
</code></pre></div>
<p>depthTexture here is a global variable, since the <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr> is created once, during initialization, but it will be used every time the image is drawn. The format of the <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr> describes the data stored for each <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr>. The value used here, "depth24plus", means that the <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr> holds at least 24 bits of depth information per <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr>. The usage means that this <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr> can be attached to a render <abbr title="A sequence of computational stages in a GPU that are applied to incoming data to produce some result. Some of the stages can be programmable shaders, such as vertex shaders, fragment shaders, and compute shaders. In a graphics rendering pipeline, the output is the colors of the pixels in an image.">pipeline</abbr>.</p>
<p>When the <abbr title="A sequence of computational stages in a GPU that are applied to incoming data to produce some result. Some of the stages can be programmable shaders, such as vertex shaders, fragment shaders, and compute shaders. In a graphics rendering pipeline, the output is the colors of the pixels in an image.">pipeline</abbr> is created, the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> must be enabled in the <abbr title="A sequence of computational stages in a GPU that are applied to incoming data to produce some result. Some of the stages can be programmable shaders, such as vertex shaders, fragment shaders, and compute shaders. In a graphics rendering pipeline, the output is the colors of the pixels in an image.">pipeline</abbr> by adding a depthStencil property to the <abbr title="A sequence of computational stages in a GPU that are applied to incoming data to produce some result. Some of the stages can be programmable shaders, such as vertex shaders, fragment shaders, and compute shaders. In a graphics rendering pipeline, the output is the colors of the pixels in an image.">pipeline</abbr> descriptor that is used in the device.createRenderPipeline() function:</p>
<div class="highlight"><pre><span></span><code><span class="nx">depthStencil</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// enable the depth test for this pipeline</span>
<span class="nx">depthWriteEnabled</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="nx">depthCompare</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;less&quot;</span><span class="p">,</span>
<span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;depth24plus&quot;</span><span class="p">,</span>
<span class="p">},</span>
</code></pre></div>
<p>The format here should match the format that was specified when creating the <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr>. The values for depthWriteEnabled and depthCompare will probably be as shown. (The <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> works by comparing the depth value for a new fragment to the depth value currently stored in the <abbr title="A region of memory that stores the information needed for the depth test in 3D graphics, that is, a depth value for each pixel in the image. Also called the &quot;z-buffer.&quot;">depth buffer</abbr> for that fragment. If the comparison is false, the new fragment is discarded. The depthCompare property specifies the comparison operator that is applied. Using "less" for that property means that the fragment is used if it has depth less than the current depth; that is, items with lower depth are considered closer to the user. In some cases, "less-equal" might be a better value for this property. Setting the depthWriteEnabled property to true means that when a new fragment passes the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr>, its depth value is written to the <abbr title="A region of memory that stores the information needed for the depth test in 3D graphics, that is, a depth value for each pixel in the image. Also called the &quot;z-buffer.&quot;">depth buffer</abbr>. In some applications, it's necessary to apply the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> without saving the new depth value. This is sometimes done, for example, when drawing translucent objects (see <a href="../../c7/s4/#741-帧缓冲区操作">Subsection 7.4.1</a>).)</p>
<p>Finally, when drawing the image, the <abbr title="A region of memory that stores the information needed for the depth test in 3D graphics, that is, a depth value for each pixel in the image. Also called the &quot;z-buffer.&quot;">depth buffer</abbr> must be attached to the <abbr title="A sequence of computational stages in a GPU that are applied to incoming data to produce some result. Some of the stages can be programmable shaders, such as vertex shaders, fragment shaders, and compute shaders. In a graphics rendering pipeline, the output is the colors of the pixels in an image.">pipeline</abbr> as part of the render pass descriptor:</p>
<div class="highlight"><pre><span></span><code><span class="kd">let</span><span class="w"> </span><span class="nx">renderPassDescriptor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="nx">colorAttachments</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="nx">clearValue</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">r</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">g</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="nx">loadOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clear&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">    </span><span class="nx">storeOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">view</span><span class="o">:</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">getCurrentTexture</span><span class="p">().</span><span class="nx">createView</span><span class="p">()</span>
<span class="p">}],</span>
<span class="nx">depthStencilAttachment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// Add depth buffer to the colorAttachment</span>
<span class="w">    </span><span class="nx">view</span><span class="o">:</span><span class="w"> </span><span class="nx">depthTexture</span><span class="p">.</span><span class="nx">createView</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">depthClearValue</span><span class="o">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span>
<span class="w">    </span><span class="nx">depthLoadOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;clear&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">depthStoreOp</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
<span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
<p>Note that the view in the depthStencilAttachment is a view of the depthTexture that was created previously. The depthClearValue says that the depth for every fragment will be initialized to 1.0 when the <abbr title="A region of memory that stores the information needed for the depth test in 3D graphics, that is, a depth value for each pixel in the image. Also called the &quot;z-buffer.&quot;">depth buffer</abbr> is cleared. 1.0  is the maximum possible depth value, representing a depth that is behind anything else in the image. ("Stencil" here, by the way, refers to the stencil test, which is not covered in this textbook; memory for the stencil test is generally combined with memory for the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr>, and in <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> they would be part of the same <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr>.)</p>
<p>The "clear" properties in the renderPassDescriptor mean that the color and depth buffers will be filled with the clear value before anything is rendered. This is appropriate for the first render pass. But for any additional render passes, "clear" has to be changed to "load" in order to avoid erasing whatever was already drawn. For example, the sample program makes this change before the second render pass:</p>
<div class="highlight"><pre><span></span><code><span class="nx">renderPassDescriptor</span><span class="p">.</span><span class="nx">depthStencilAttachment</span><span class="p">.</span><span class="nx">depthLoadOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;load&quot;</span><span class="p">;</span>
<span class="nx">renderPassDescriptor</span><span class="p">.</span><span class="nx">colorAttachments</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">loadOp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;load&quot;</span><span class="p">;</span>
</code></pre></div>
<hr />
<p>The sample program actually uses <abbr title="A kind of antialiasing where the fragment shader is evaluated at several points in each pixel, and the results are averaged to get the color of the pixel.">multisampling</abbr> (<a href="../s2/#925-多重采样">Subsection 9.2.5</a>), which requires a small change when creating the depth <abbr title="Variation in some property from point-to-point on an object. The most common type is image texture. When an image texture is applied to a surface, the surface color varies from point to point.">texture</abbr>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">depthTexture</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">device</span><span class="p">.</span><span class="nx">createTexture</span><span class="p">({</span>
<span class="w">    </span><span class="nx">size</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">],</span>
<span class="w">    </span><span class="nx">format</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;depth24plus&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">sampleCount</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// Required when multisampling is used!</span>
<span class="w">    </span><span class="nx">usage</span><span class="o">:</span><span class="w"> </span><span class="nx">GPUTextureUsage</span><span class="p">.</span><span class="nx">RENDER_ATTACHMENT</span><span class="p">,</span>
<span class="p">});</span>
</code></pre></div>
</div>
</div>
</div>
<h2 id="942-坐标系">9.4.2 <abbr title="一种将数值坐标分配给几何点的方法。在二维中，每个点对应一对数字。在三维中，每个点对应一组三个数字。">坐标系</abbr><a class="headerlink" href="#942-坐标系" title="Permanent link">&para;</a></h2>
<p><strong>Coordinate Systems</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="__tabbed_3_1">中文</label><label for="__tabbed_3_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>我们一直在使用默认的WebGPU坐标系统，其中x轴从左到右范围是-1.0到1.0，y轴从下到上范围是-1.0到1.0，深度或z值从前到后范围是0.0到1.0。坐标超出这些范围的点不构成图像的一部分。这个坐标系统被称为<strong><abbr title="一种表示 n 维向量为 (n+1) 维向量的方法，其中两个 (n+1) 向量如果它们相差一个标量倍数，则表示相同的 n 维向量。例如，在 3D 中，如果 w 不为零，那么齐次坐标 (x,y,z,w) 与齐次坐标 (x/w,y/w,z/w,1) 等价，因为它们相差 w 的标量乘法。这两组坐标都表示 3D 向量 (x/w,y/w,z/w)。">归一化设备坐标</abbr></strong>（<abbr title="Normalized Device Coordinates. In WebGPU, refers to the default xyz coordinate system in which x and y range from -1 to 1 and z ranges from 0 to 1. The x and y in NDC map linearly to device, or pixel, coordinates on the viewport.">NDC</abbr>）。（OpenGL使用“<abbr title="OpenGL中的默认坐标系。投影变换将三维场景映射到裁剪坐标。渲染图像将显示裁剪坐标系中的立方体内容，其中x、y和z值的范围为-1到1；任何超出该范围的内容将被“裁剪”掉。">裁剪坐标</abbr>”来称呼其默认坐标系统；WebGPU使用该术语来指代其默认系统的齐次坐标，<code>(x,y,z,w)</code>；也就是说，从裁剪坐标到NDC的变换是通过将<code>(x,y,z,w)</code>映射到<code>(x/w,y/w,z/w)</code>来实现的。）</p>
<p>归一化设备坐标被映射到光栅化过程中的视口坐标。视口坐标是正在渲染的矩形区域上的像素或设备坐标，其中(0,0)位于左上角，每个像素的高度和宽度等于1。视口坐标还包括未变换的深度值，范围在0到1之间。当片段着色器使用@builtin(position)输入时，其值以视口坐标给出。通常，片段着色器中像素的xy坐标将是该像素的中心，对于视口左上角的像素，坐标如(0.5,0.5)是半整数坐标。对于多重采样，像素内的其他点被使用。</p>
<p>但是，我们希望在绘制时能够使用我们选择的坐标系统。这就引入了几个新的坐标系统：<abbr title="对象中的点的坐标最初在其中指定的坐标系统，然后通过应用于对象的任何建模或其他变换来转换这些坐标。">对象坐标</abbr>，顶点最初指定时的坐标系统；<abbr title="定义场景的坐标系统。生成的场景图像将显示位于某个视图体积（对于3D）或视图窗口（对于2D）内的世界坐标系统中的内容。对象在其自己的对象坐标系统中定义。然后应用建模变换将对象放置到场景中，即将对象坐标转换为世界坐标。">世界坐标</abbr>，整个场景任意的坐标系统；以及眼坐标，代表用户视角下的世界，观察者位于(0,0,0)，x轴从左到右延伸，y轴指向上方，z轴指向屏幕内部。所有这些坐标系统以及它们之间的变换在<a href="../../c3/s3/">第3.3节</a>中有详细讨论。这张图从该节中重复使用：</p>
<p><a href="../../../en/c9/opengl-transform-pipeline.png">123</a></p>
<p>对于WebGPU，您应该将“<abbr title="OpenGL中的默认坐标系。投影变换将三维场景映射到裁剪坐标。渲染图像将显示裁剪坐标系中的立方体内容，其中x、y和z值的范围为-1到1；任何超出该范围的内容将被“裁剪”掉。">裁剪坐标</abbr>”与归一化设备坐标等同起来，并将“<abbr title="在显示设备或渲染图像上使用的坐标系，通常以像素作为度量单位。">设备坐标</abbr>”与视口坐标等同起来。</p>
<p>重要的是要理解，只有归一化设备坐标、视口坐标和视口变换是内置于WebGPU中的。其他坐标系统和变换是在代码中实现的，无论是在JavaScript端还是在着色器程序中。</p>
<p>建模变换和观察变换通常结合成一个模型视图变换，如上所示，原因在<a href="../../c3/s3/#334-模型视图转换">3.3.4小节</a>中解释。所以，程序通常只需要处理模型视图和投影变换。</p>
<p>图中没有展示一个重要的变换。表面法向量在光照中扮演重要角色（见<a href="../../c4/s1/#413-法向量">4.1.3小节</a>）。当对象通过模型视图变换时，它的法向量也必须被变换。法向量的变换与模型视图变换不同，但可以从中派生。</p>
<p>所有这些变换都以矩阵形式实现。模型视图和投影变换是4x4矩阵。法向量的变换矩阵是3x3矩阵。</p>
</div>
<div class="tabbed-block">
<p>We have been using the default <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr>, in which x ranges from -1.0 to 1.0 from left to right, y ranges from -1.0 to 1.0 from bottom to top, and the depth, or z-value, ranges from 0.0 to 1.0 from front to back. Points with coordinates outside these ranges are not part of the image. This <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr> is referred to as <strong>normalized <abbr title="The coordinate system used on a display device or rendered image, often using pixels as the unit of measure.">device coordinates</abbr></strong> (<abbr title="Normalized Device Coordinates. In WebGPU, refers to the default xyz coordinate system in which x and y range from -1 to 1 and z ranges from 0 to 1. The x and y in NDC map linearly to device, or pixel, coordinates on the viewport.">NDC</abbr>). (<abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr> uses the term "<abbr title="The default coordinate system in OpenGL. The projection transform maps the 3D scene to clip coordinates. The rendered image will show the contents of the cube in the clip coordinate system that contains x, y, and z values in the range from -1 to 1; anything outside that range is &quot;clipped&quot; away.">clip coordinates</abbr>" for its default <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr>; <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> uses that term to refer to <abbr title="A way of representing n-dimensional vectors as (n+1)-dimensional vectors where two (n+1) vectors represent the same n-dimensional vector if they differ by a scalar multiple. In 3D, for example, if w is not zero, then the homogeneous coordinates (x,y,z,w) are equivalent to homogeneous coordinates (x/w,y/w,z/w,1), since they differ by multiplication by the scalar w. Both sets of coordinates represent the 3D vector (x/w,y/w,z/w)">homogeneous coordinates</abbr>, <code>(x,y,z,w)</code>, for its default system; that is, the transformation from <abbr title="The default coordinate system in OpenGL. The projection transform maps the 3D scene to clip coordinates. The rendered image will show the contents of the cube in the clip coordinate system that contains x, y, and z values in the range from -1 to 1; anything outside that range is &quot;clipped&quot; away.">clip coordinates</abbr> to <abbr title="Normalized Device Coordinates. In WebGPU, refers to the default xyz coordinate system in which x and y range from -1 to 1 and z ranges from 0 to 1. The x and y in NDC map linearly to device, or pixel, coordinates on the viewport.">NDC</abbr> is given by mapping <code>(x,y,z,w)</code> to <code>(x/w,y/w,z/w)</code>.)</p>
<p>Normalized <abbr title="The coordinate system used on a display device or rendered image, often using pixels as the unit of measure.">device coordinates</abbr> are mapped to <abbr title="The rectangular area in which the image for 2D or 3D graphics is displayed. The coordinates on the viewport are pixel coordinates, more properly called device coordinates since they are actual physical coordinates on the device where the image is being displayed.">viewport</abbr> coordinates for <abbr title="The process of creating a raster image, that is one made of pixels, from other data that specifies the content of the image. For example, a vector graphics image must be rasterized in order to be displayed on a computer screen.">rasterization</abbr>. Viewport coordinates are <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr> or <abbr title="The coordinate system used on a display device or rendered image, often using pixels as the unit of measure.">device coordinates</abbr> on the rectangular region that is being rendered, with (0,0) at the top left corner and each <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr> having height and width equal to 1. Viewport coordinates also include the untransformed depth value between 0 and 1. When a <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr> uses the @builtin(position) input, its values are given in <abbr title="The rectangular area in which the image for 2D or 3D graphics is displayed. The coordinates on the viewport are pixel coordinates, more properly called device coordinates since they are actual physical coordinates on the device where the image is being displayed.">viewport</abbr> coordinates. Ordinarily the xy coordinates for a <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr> in the <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr> will be the center of that <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr>, with half-integer coordinates such as <code>(0.5,0.5)</code> for the <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr> in the upper left corner of the <abbr title="The rectangular area in which the image for 2D or 3D graphics is displayed. The coordinates on the viewport are pixel coordinates, more properly called device coordinates since they are actual physical coordinates on the device where the image is being displayed.">viewport</abbr>. For <abbr title="A kind of antialiasing where the fragment shader is evaluated at several points in each pixel, and the results are averaged to get the color of the pixel.">multisampling</abbr>, other points within the <abbr title="A digital image is made up of rows and columns of small rectangles called pixels. To specify a digital image, a color is assigned to each pixel in the image.">pixel</abbr> are used.</p>
<p>But we want to be able to use the <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr> of our choice when drawing. That brings in several new <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate systems</abbr>: <abbr title="The coordinate system in which the coordinates for points in an object are originally specified, before they are transformed by any modeling or other transform that will be applied to the object.">object coordinates</abbr>, the <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr> in which vertices are originally specified; <abbr title="The coordinate system in which a scene is defined. The image that is produced of the scene will show the contents of the world coordinate system that lie within some view volume (for 3D) or view window (for 2D). Objects are defined in their own object coordinate system. Modeling transformations are then applied to place objects into the scene; that is, they transform object coordinates to world coordinates.">world coordinates</abbr>, the arbitrary <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr> on the scene as a whole; and <abbr title="The coordinate system on 3D space defined by the viewer. In eye coordinates in OpenGL 1.1, the viewer is located at the origin, looking in the direction of the negative z-axis, with the positive y-axis pointing upwards, and the positive x-axis pointing to the right. The modelview transformation maps objects into the eye coordinate system, and the projection transform maps eye coordinates to clip coordinates.">eye coordinates</abbr>, which represent the world from the point of view of the user, with the viewer at (0,0,0), the x-axis stretching from left to right, the y-axis pointing up, and the z-axis pointing into the screen. All of these <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate systems</abbr> and the transformations between them are discussed extensively in <a href="../../c3/s3/">Section 3.3</a>. This illustration is repeated from that section:</p>
<p><a href="../../../en/c9/opengl-transform-pipeline.png">123</a></p>
<p>For <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr>, you should identify "<abbr title="The default coordinate system in OpenGL. The projection transform maps the 3D scene to clip coordinates. The rendered image will show the contents of the cube in the clip coordinate system that contains x, y, and z values in the range from -1 to 1; anything outside that range is &quot;clipped&quot; away.">clip coordinates</abbr>" with normalized <abbr title="The coordinate system used on a display device or rendered image, often using pixels as the unit of measure.">device coordinates</abbr> and "<abbr title="The coordinate system used on a display device or rendered image, often using pixels as the unit of measure.">device coordinates</abbr>" with <abbr title="The rectangular area in which the image for 2D or 3D graphics is displayed. The coordinates on the viewport are pixel coordinates, more properly called device coordinates since they are actual physical coordinates on the device where the image is being displayed.">viewport</abbr> coordinates.</p>
<p>It is important to understand that only normalized <abbr title="The coordinate system used on a display device or rendered image, often using pixels as the unit of measure.">device coordinates</abbr>, <abbr title="The rectangular area in which the image for 2D or 3D graphics is displayed. The coordinates on the viewport are pixel coordinates, more properly called device coordinates since they are actual physical coordinates on the device where the image is being displayed.">viewport</abbr> coordinates, and the <abbr title="The rectangular area in which the image for 2D or 3D graphics is displayed. The coordinates on the viewport are pixel coordinates, more properly called device coordinates since they are actual physical coordinates on the device where the image is being displayed.">viewport</abbr> transformation are built into <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr>. The other <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate systems</abbr> and transformations are implemented in code either on the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> side or in the <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> program.</p>
<p>The modeling transform and <abbr title="Setting the position and orientation of the viewer in a 3D world, which determine what will be visible when the 2D image of a 3D world is rendered.">viewing</abbr> transform are usually combined into a modelview transform, as shown, for reasons explained in <a href="../../c3/s3/#334-模型视图转换">Subsection 3.3.4</a>. So a program generally only needs to work with the modelview and <abbr title="A transformation that maps coordinates in 3D to coordinates in 2D. Projection is used to convert a three-dimensional scene into a two-dimensional image.">projection</abbr> transforms.</p>
<p>There is one important transformation not shown in the diagram. Normal vectors for surfaces play an important role in <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> (<a href="../../c4/s1/#413-法向量">Subsection 4.1.3</a>). When an object is transformed by the <abbr title="In OpenGL 1.1, a transform that combines the modeling transform with the viewing transform. That is, it is the composition of the transformation from object coordinates to world coordinates and the transformation from world coordinates to eye coordinates. Because of the equivalence between modeling and viewing transformations, world coordinates are not really meaningful for OpenGL, and only the combined transformation is tracked.">modelview transformation</abbr>, its normal vectors must also be transformed. The transformation for normal vectors is not the same as the <abbr title="In OpenGL 1.1, a transform that combines the modeling transform with the viewing transform. That is, it is the composition of the transformation from object coordinates to world coordinates and the transformation from world coordinates to eye coordinates. Because of the equivalence between modeling and viewing transformations, world coordinates are not really meaningful for OpenGL, and only the combined transformation is tracked.">modelview transformation</abbr> but can be derived from it.</p>
<p>All of these transformations are implemented as matrices. The modelview and <abbr title="A transformation that maps coordinates in 3D to coordinates in 2D. Projection is used to convert a three-dimensional scene into a two-dimensional image.">projection</abbr> transformations are 4-by-4 matrices. The transformation <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> for normal vectors is a 3-by-3 <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.</p>
</div>
</div>
</div>
<h2 id="943-进入-3d">9.4.3 进入 3D<a class="headerlink" href="#943-进入-3d" title="Permanent link">&para;</a></h2>
<p><strong>Into 3D</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="__tabbed_4_1">中文</label><label for="__tabbed_4_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>示例程序 <a href="../../../en/source/webgpu/Phong_lighting.html">webgpu/Phong_lighting.html</a> 是我们在 <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> 中的第一个 3D 图形示例。这个程序的功能与 <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr> 版本相同，<a href="../../../en/source/webgl/basic-specular-lighting-Phong.html">webgl/basic-specular-<abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr>-Phong.html</a>。它一次显示一个对象，由单一的白色光源照亮。用户可以控制显示的对象以及对象的材质属性，并且用户可以通过拖动图像来旋转对象。对象被定义为索引面集，并使用索引绘制进行渲染。</p>
<p>各种属性由程序的 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 端提供，并在着色器程序中使用。我已经将它们全部收集到着色器程序中的一个结构体中：</p>
<div class="highlight"><pre><span></span><code><span class="nx">struct</span><span class="w"> </span><span class="nx">UniformData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">modelview</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">mat4x4f</span><span class="p">,</span><span class="w">   </span><span class="c1">// 大小 16，偏移量 0  </span>
<span class="w">    </span><span class="nx">projection</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">mat4x4f</span><span class="p">,</span><span class="w">  </span><span class="c1">// 大小 16，偏移量 16 （以 4 字节浮点数为单位）</span>
<span class="w">    </span><span class="nx">normalMatrix</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">mat3x3f</span><span class="p">,</span><span class="c1">// 大小 12，偏移量 32</span>
<span class="w">    </span><span class="nx">lightPosition</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec4f</span><span class="p">,</span><span class="w"> </span><span class="c1">// 大小 4，偏移量 44</span>
<span class="w">    </span><span class="nx">diffuseColor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w">  </span><span class="c1">// 大小 3，偏移量 48</span>
<span class="w">    </span><span class="nx">specularColor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w"> </span><span class="c1">// 大小 3，偏移量 52</span>
<span class="w">    </span><span class="nx">specularExponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">f32</span><span class="w"> </span><span class="c1">// 大小 1，偏移量 55</span>
<span class="p">}</span>

<span class="err">@</span><span class="nx">group</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="nx">binding</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="kd">var</span><span class="o">&lt;</span><span class="nx">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">uniformData</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">UniformData</span><span class="p">;</span>
</code></pre></div>
<p>这在 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 端由一个长度为 56 的 <strong><em>Float32Array</em></strong>，userData 支持，值从该数组写入到 <abbr title="Graphics Processing Unit, a computer hardware component that performs graphical computations that create and manipulate images. Operations such as drawing a line on the screen or rendering a 3D image are done in the GPU, which is optimized to perform such operations very quickly.">GPU</abbr> 端持有该结构体的 uniform 缓冲区。上述结构体成员的偏移量对应于数组中的索引。例如，要将漫反射颜色设置为红色，我们可能会说：</p>
<div class="highlight"><pre><span></span><code><span class="nx">userData</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="mf">48</span><span class="w"> </span><span class="p">);</span>
<span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">(</span><span class="w"> </span><span class="nx">uniformBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="o">*</span><span class="mf">48</span><span class="p">,</span><span class="w"> </span><span class="nx">uniformData</span><span class="p">,</span><span class="w"> </span><span class="mf">48</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>类型化数组方法 userData.set(array,index) 将数组的元素复制到 userData，从指定的索引开始。在 writeBuffer() 调用中，注意第二个参数给出了缓冲区中数据的字节偏移量，这是以浮点数为单位的偏移量的四倍。第四个参数是在类型化数组中要复制的数据的起始索引，第五个参数给出了要复制的数组元素的数量 —— 而不是字节。（程序实际上比这个示例更有组织地从 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 端到 <abbr title="Graphics Processing Unit, a computer hardware component that performs graphical computations that create and manipulate images. Operations such as drawing a line on the screen or rendering a 3D image are done in the GPU, which is optimized to perform such operations very quickly.">GPU</abbr> 端复制各种数据项。）</p>
<p>在着色器程序中，模型视图和投影矩阵在顶点着色器中使用，结构体的其他成员在片段着色器中使用。（将顶点着色器和片段着色器的数据组合在同一个结构体中，就像我在这里做的，可能不是最佳实践。）顶点着色器的输入是顶点的 3D 坐标和法向量。向量坐标以对象坐标系给出。顶点着色器的输出是顶点在裁剪坐标系中的位置（这是必需的输出），法向量和顶点在眼坐标系中的位置：</p>
<div class="highlight"><pre><span></span><code><span class="nx">struct</span><span class="w"> </span><span class="nx">VertexOut</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">@</span><span class="nx">builtin</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec4f</span><span class="p">,</span>
<span class="w">    </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">normal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span>
<span class="p">}</span>

<span class="err">@</span><span class="nx">vertex</span>
<span class="nx">fn</span><span class="w"> </span><span class="nx">vmain</span><span class="p">(</span><span class="w"> </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">coords</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span>
<span class="w">        </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="nx">normal</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">VertexOut</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uniformData</span><span class="p">.</span><span class="nx">modelview</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">vec4f</span><span class="p">(</span><span class="nx">coords</span><span class="p">,</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">VertexOut</span><span class="p">;</span>
<span class="w">    </span><span class="nx">output</span><span class="p">.</span><span class="nx">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uniformData</span><span class="p">.</span><span class="nx">projection</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="p">;</span>
<span class="w">    </span><span class="nx">output</span><span class="p">.</span><span class="nx">normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="nx">normal</span><span class="p">);</span><span class="w">  </span><span class="c1">// 确保它是一个单位向量</span>
<span class="w">    </span><span class="nx">output</span><span class="p">.</span><span class="nx">eyeCoords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="p">.</span><span class="nx">xyz</span><span class="o">/</span><span class="nx">eyeCoords</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span><span class="w">  </span><span class="c1">// 转换为 (x,y,z) 坐标</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>要理解这段代码，你需要理解各种坐标系以及 <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> 对矩阵和向量数学的支持。顶点的眼坐标通过将齐次对象坐标向量与模型视图矩阵相乘来获得。这给出了齐次 (x,y,z,w) 眼坐标，通过将 vec3f eyeCoords.xyz 除以 w <abbr title="一种将数值坐标分配给几何点的方法。在二维中，每个点对应一对数字。在三维中，每个点对应一组三个数字。">坐标</abbr> eyeCoords.w 转换为普通的 (x,y,z) <abbr title="一种将数值坐标分配给几何点的方法。在二维中，每个点对应一对数字。在三维中，每个点对应一组三个数字。">坐标</abbr>。必须以裁剪坐标系给出的位置输出，通过将眼坐标向量与投影矩阵相乘来获得。</p>
<p>顶点着色器输出的单位法向量和眼坐标成为片段着色器的输入，在那里它们用于光照计算。（当然，片段的它们的值是从包含片段的三角形的顶点插值得到的。）Phong 光照指的是在片段着色器中使用插值法向量和基本的 <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr> 光照模型进行光照计算（见 <a href="../../c4/s1/#414-opengl-11-光照方程">4.1.4小节</a> 和 <a href="../../c7/s2/#722-镜面反射和-phong-着色">7.2.2小节</a>）。本节最后一个示例中将更多地讨论光照。</p>
</div>
<div class="tabbed-block">
<p>The sample program <a href="../../../en/source/webgpu/Phong_lighting.html">webgpu/Phong_lighting.html</a> is our first example of 3D graphics in <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr>. This program has functionality identical to the <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr> version, <a href="../../../en/source/webgl/basic-specular-lighting-Phong.html">webgl/basic-specular-<abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr>-Phong.html</a>. It displays one object at a time, illuminated by a single white light source. The user has some control over what object is shown and the <abbr title="The properties of an object that determine how that object interacts with light in the environment. Material properties in OpenGL include, for example, diffuse color, specular color, and shininess.">material</abbr> properties of the object, and the user can rotate the object by dragging on the image. The objects are defined as indexed face sets and are rendered using <abbr title="In WebGPU, drawing a primitive using the drawIndexed() function. With that function, vertices are not generated in the order in which they are listed. Instead, a list of vertex indices in an index buffer determines the order of the vertices. Indexed drawing is used to render indexed face sets.">indexed drawing</abbr>.</p>
<p>Various properties are provided by the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> side of the program and used in the <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> program. I have collected them all into a single struct in the <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> program:</p>
<div class="highlight"><pre><span></span><code><span class="nx">struct</span><span class="w"> </span><span class="nx">UniformData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">modelview</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">mat4x4f</span><span class="p">,</span><span class="w">   </span><span class="c1">// size 16, offset 0  </span>
<span class="w">    </span><span class="nx">projection</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">mat4x4f</span><span class="p">,</span><span class="w">  </span><span class="c1">// size 16, offset 16 (measured in 4-byte floats)</span>
<span class="w">    </span><span class="nx">normalMatrix</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">mat3x3f</span><span class="p">,</span><span class="c1">// size 12, offset 32</span>
<span class="w">    </span><span class="nx">lightPosition</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec4f</span><span class="p">,</span><span class="w"> </span><span class="c1">// size  4, offset 44</span>
<span class="w">    </span><span class="nx">diffuseColor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w">  </span><span class="c1">// size  3, offset 48</span>
<span class="w">    </span><span class="nx">specularColor</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w"> </span><span class="c1">// size  3, offset 52</span>
<span class="w">    </span><span class="nx">specularExponent</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">f32</span><span class="w"> </span><span class="c1">// size  1, offset 55</span>
<span class="p">}</span>

<span class="err">@</span><span class="nx">group</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="nx">binding</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="kd">var</span><span class="o">&lt;</span><span class="nx">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="nx">uniformData</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">UniformData</span><span class="p">;</span>
</code></pre></div>
<p>This is backed on the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> side by a <strong><em>Float32Array</em></strong>, userData, of length 56, and values are written from that array into the uniform buffer that holds the struct on the <abbr title="Graphics Processing Unit, a computer hardware component that performs graphical computations that create and manipulate images. Operations such as drawing a line on the screen or rendering a 3D image are done in the GPU, which is optimized to perform such operations very quickly.">GPU</abbr> side. The offsets listed above for members of the struct correspond to indices in the array. For example, to set the <abbr title="A material property that represents the proportion of incident light that is reflected diffusely from a surface.">diffuse color</abbr> to red, we might say</p>
<div class="highlight"><pre><span></span><code><span class="nx">userData</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="w"> </span><span class="p">[</span><span class="mf">1</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="mf">48</span><span class="w"> </span><span class="p">);</span>
<span class="nx">device</span><span class="p">.</span><span class="nx">queue</span><span class="p">.</span><span class="nx">writeBuffer</span><span class="p">(</span><span class="w"> </span><span class="nx">uniformBuffer</span><span class="p">,</span><span class="w"> </span><span class="mf">4</span><span class="o">*</span><span class="mf">48</span><span class="p">,</span><span class="w"> </span><span class="nx">uniformData</span><span class="p">,</span><span class="w"> </span><span class="mf">48</span><span class="p">,</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>The <abbr title="In JavaScript, an array type that is limited to holding numerical values of a single type. For example, the type Float32Array represents arrays that can hold 32-bit floating point values, and Uint8Array arrays can hold only 8-bit integer values. Such arrays are more efficient than general JavaScript arrays for numerical calculations. The were introduced into JavaScript along with HTML canvas graphics and WebGL.">typed array</abbr> method userData.set(array,index) copies the elements of the array into userData, starting at the specified index. In the call to writeBuffer(), note that the second parameter gives the byte offset of the data in the buffer, which is four times the offset measured in floats. The fourth parameter is the starting index in the <abbr title="In JavaScript, an array type that is limited to holding numerical values of a single type. For example, the type Float32Array represents arrays that can hold 32-bit floating point values, and Uint8Array arrays can hold only 8-bit integer values. Such arrays are more efficient than general JavaScript arrays for numerical calculations. The were introduced into JavaScript along with HTML canvas graphics and WebGL.">typed array</abbr> of the data to be copied, and the fifth parameter gives the number of elements—not bytes—of the array to be copied. (The program is actually more organized than this example about copying the various data items from the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> to the <abbr title="Graphics Processing Unit, a computer hardware component that performs graphical computations that create and manipulate images. Operations such as drawing a line on the screen or rendering a 3D image are done in the GPU, which is optimized to perform such operations very quickly.">GPU</abbr> side.)</p>
<p>In the <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> program, the modelview and <abbr title="A transformation that maps coordinates in 3D to coordinates in 2D. Projection is used to convert a three-dimensional scene into a two-dimensional image.">projection</abbr> matrices are used in the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr>, and the other members of the struct are used in the <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr>. (It is probably not best practice to combine data for the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> and <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr> in the same struct, as I have done here.) The inputs to the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> are the 3D coordinates and the <abbr title="A normal vector to a surface at a point on that surface is a vector that is perpendicular to the surface at that point. Normal vectors to curves are defined similarly. Normal vectors are important for lighting calculations.">normal vector</abbr> for the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr>. The <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> coordinates are given in the object <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr>. The <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> outputs are the position of the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> in <abbr title="The default coordinate system in OpenGL. The projection transform maps the 3D scene to clip coordinates. The rendered image will show the contents of the cube in the clip coordinate system that contains x, y, and z values in the range from -1 to 1; anything outside that range is &quot;clipped&quot; away.">clip coordinates</abbr> (which is a required output), the <abbr title="A normal vector to a surface at a point on that surface is a vector that is perpendicular to the surface at that point. Normal vectors to curves are defined similarly. Normal vectors are important for lighting calculations.">normal vector</abbr>, and the position of the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> in the eye <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate system</abbr>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">struct</span><span class="w"> </span><span class="nx">VertexOut</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="err">@</span><span class="nx">builtin</span><span class="p">(</span><span class="nx">position</span><span class="p">)</span><span class="w"> </span><span class="nx">position</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec4f</span><span class="p">,</span>
<span class="w">    </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">normal</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span>
<span class="p">}</span>

<span class="err">@</span><span class="nx">vertex</span>
<span class="nx">fn</span><span class="w"> </span><span class="nx">vmain</span><span class="p">(</span><span class="w"> </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">0</span><span class="p">)</span><span class="w"> </span><span class="nx">coords</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span>
<span class="w">        </span><span class="err">@</span><span class="nx">location</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="nx">normal</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">VertexOut</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uniformData</span><span class="p">.</span><span class="nx">modelview</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">vec4f</span><span class="p">(</span><span class="nx">coords</span><span class="p">,</span><span class="mf">1</span><span class="p">);</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">output</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">VertexOut</span><span class="p">;</span>
<span class="w">    </span><span class="nx">output</span><span class="p">.</span><span class="nx">position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">uniformData</span><span class="p">.</span><span class="nx">projection</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="p">;</span>
<span class="w">    </span><span class="nx">output</span><span class="p">.</span><span class="nx">normal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="nx">normal</span><span class="p">);</span><span class="w">  </span><span class="c1">// make sure it&#39;s a unit vector</span>
<span class="w">    </span><span class="nx">output</span><span class="p">.</span><span class="nx">eyeCoords</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="p">.</span><span class="nx">xyz</span><span class="o">/</span><span class="nx">eyeCoords</span><span class="p">.</span><span class="nx">w</span><span class="p">;</span><span class="w">  </span><span class="c1">// convert to (x,y,z) coords</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">output</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>To understand this code, you need to understand the various <abbr title="A way of assigning numerical coordinates to geometric points. In two dimensions, each point corresponds to a pair of numbers. In three dimensions, each point corresponds to a triple of numbers.">coordinate systems</abbr> and the support in <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> for <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> and <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> math. The <abbr title="The coordinate system on 3D space defined by the viewer. In eye coordinates in OpenGL 1.1, the viewer is located at the origin, looking in the direction of the negative z-axis, with the positive y-axis pointing upwards, and the positive x-axis pointing to the right. The modelview transformation maps objects into the eye coordinate system, and the projection transform maps eye coordinates to clip coordinates.">eye coordinates</abbr> of the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> are obtained by multiplying the homogeneous object coordinate <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> by the modelview <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>. This gives the homogeneous (x,y,z,w) <abbr title="The coordinate system on 3D space defined by the viewer. In eye coordinates in OpenGL 1.1, the viewer is located at the origin, looking in the direction of the negative z-axis, with the positive y-axis pointing upwards, and the positive x-axis pointing to the right. The modelview transformation maps objects into the eye coordinate system, and the projection transform maps eye coordinates to clip coordinates.">eye coordinates</abbr>, which are converted to ordinary (x,y,z) coordinates by dividing the vec3f eyeCoords.xyz by the w-coordinate, eyeCoords.w. The position output, which must be given in <abbr title="The default coordinate system in OpenGL. The projection transform maps the 3D scene to clip coordinates. The rendered image will show the contents of the cube in the clip coordinate system that contains x, y, and z values in the range from -1 to 1; anything outside that range is &quot;clipped&quot; away.">clip coordinates</abbr>, is obtained by multiplying the eye coordinate <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> by the <abbr title="A transformation that maps coordinates in 3D to coordinates in 2D. Projection is used to convert a three-dimensional scene into a two-dimensional image.">projection</abbr> <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.</p>
<p>The <abbr title="A normal vector of length one; that is, a unit vector that is perpendicular to a curve or surface at a given point on the curve or surface.">unit normal</abbr> and eye coordinate outputs from the <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> become inputs to the <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr>, where they are used in the <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> calculation. (Their values for a fragment are, of course, interpolated from the vertices of the triangle that contains the fragment.) Phong <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> refers to doing <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> calculations in the <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr> using interpolated normal vectors and the basic <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr> <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> model (see <a href="../../c4/s1/#414-opengl-11-光照方程">Subsection 4.1.4</a> and <a href="../../c7/s2/#722-镜面反射和-phong-着色">Subsection 7.2.2</a>). There is more about <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> in the last example in this section.</p>
</div>
</div>
</div>
<h2 id="944-wgpu-矩阵">9.4.4 wgpu <abbr title="数字的矩形数组。矩阵可以表示为二维数组，数字按行和列排列。一个N×N矩阵表示从N维空间到自身的线性变换。">矩阵</abbr><a class="headerlink" href="#944-wgpu-矩阵" title="Permanent link">&para;</a></h2>
<p><strong>wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr></strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="__tabbed_5_1">中文</label><label for="__tabbed_5_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p>在程序的 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 端处理矩阵和向量时，使用一个支持矩阵和向量数学的 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 库会很方便。对于 <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr>，我们使用了 <abbr title="一个用于二维和三维向量和矩阵数学的开源JavaScript库。">glMatrix</abbr>（见 <a href="../../c7/s1/#712-glmatrix简介">7.1.2小节</a>）。对于 <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr>，我们需要一个不同的库，原因有几个。一个原因是 <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> 中裁剪坐标的 z 范围是从 0 到 1，而在 <abbr title="OpenGL Shader Language, the programming language that is used to write shader programs for use with OpenGL.">GLSL</abbr> 中，范围是从 -1 到 1。这意味着两种着色语言中的投影矩阵将会不同。第二个原因是 <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> 中的 3x3 矩阵包含 12 个浮点数，因为对齐问题（见 <a href="../s3/#931-地址空间和对齐">9.3.1小节</a>），而在 <abbr title="OpenGL Shader Language, the programming language that is used to write shader programs for use with OpenGL.">GLSL</abbr> 中，3x3 矩阵包含 9 个浮点数。</p>
<p>在我的示例中，我使用了 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 库（<a href="../../../en/source/webgpu/wgpu-matrix.js">webgpu/wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.js</a>），由 Gregg Tavares 开发，根据 MIT 开源许可证分发。可以在其网页 <a href="https://wgpu-matrix.org/">https://wgpu-matrix.org/</a> 上找到下载和文档链接。（我的一些示例使用了该库的更小的，“压缩的”版本，<a href="../../../en/source/webgpu/wgpu-matrix.min.js">webgpu/wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.min.js</a>，该版本不适合人类阅读。）我在 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 下载的 "dist" 文件夹中找到了 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 文件。</p>
<p>模型视图变换矩阵可以在 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 端计算，从单位矩阵开始，然后乘以由缩放、旋转和平移给出的观察和建模变换。有几种熟悉的方法来构造正交和透视投影矩阵（见 <a href="../../c3/s3/#333-投影变换">3.3.3小节</a>）。所有这些都是使用 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 容易实现的。</p>
<p>在 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.js 中，矩阵和数学函数是对象 wgpuMatrix.mat4、wgpuMatrix.mat3 和 wgpuMatrix.vec4 等的属性。矩阵和向量表示为具有适当长度的 Float32Arrays。它们可以直接作为 <strong><em>Float32Arrays</em></strong> 创建，或者通过调用库中的函数创建；例如：</p>
<div class="highlight"><pre><span></span><code><span class="nx">matrix4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span><span class="w">  </span><span class="c1">// 一个 4x4 矩阵</span>
<span class="nx">vector3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">vec3</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span><span class="w">  </span><span class="c1">// 一个 3 维向量</span>
</code></pre></div>
<p>这些函数创建填充有零的数组。大多数矩阵和向量操作都会产生一个矩阵或向量作为输出。在 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 中，您通常可以将现有的矩阵或向量作为函数的最后一个参数传递，以接收输出。然而，那个参数是可选的，如果没有提供，库将为输出创建一个新的矩阵或向量。在任何情况下，输出都是函数的返回值。例如，如果 modelview 是当前的模型视图矩阵，并且如果您想应用 [3,6,4] 的平移，您可以这样说：</p>
<div class="highlight"><pre><span></span><code><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="w"> </span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">4</span><span class="p">],</span><span class="w"> </span><span class="nx">modelview</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>或者</p>
<div class="highlight"><pre><span></span><code><span class="nx">modelview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="w"> </span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">4</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>第一个版本当然更有效率。</p>
<p>让我们看看 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.js 中一些最重要的函数。这将包括在我的示例中使用的所有函数。创建投影矩阵最常见的方法是：</p>
<div class="highlight"><pre><span></span><code><span class="nx">projMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">perspective</span><span class="p">(</span><span class="w"> </span><span class="nx">fovy</span><span class="p">,</span><span class="w"> </span><span class="nx">aspect</span><span class="p">,</span><span class="w"> </span><span class="nx">near</span><span class="p">,</span><span class="w"> </span><span class="nx">far</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>其中 fovy 是垂直视场角度，以弧度给出，aspect 是图像宽度与其高度的比率，near 是近裁剪面距离观察者的距离，far 是远裁剪面的距离。这基本上与 <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr> 中的 gluPerspective() 函数相同（见 <a href="../../c3/s3/#333-投影变换">3.3.3小节</a>），除了用弧度而不是度数来测量角度。glOrtho() 和 glFrustum() 的等价函数也在 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 中可用。</p>
<p>对于模型视图矩阵，通常从观察变换开始。对此，gluLookAt() 的等价函数很方便：</p>
<div class="highlight"><pre><span></span><code><span class="nx">modelview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span><span class="w"> </span><span class="nx">eye</span><span class="p">,</span><span class="w"> </span><span class="nx">viewRef</span><span class="p">,</span><span class="w"> </span><span class="nx">viewUp</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>参数是 3 维向量，可以指定为常规的 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 数组。这为位于 eye 的观察者构建了一个视图矩阵，观察方向朝向 viewRef，<abbr title="向量空间中的元素。向量空间的元素可以相加，并且可以乘以常数。对于计算机图形，向量只是包含两个、三个或四个数字的列表或数组。在这个意义上，向量通常用于表示2D、3D或4D空间中的点。然而，准确地说，向量表示具有长度和方向的数量；以这种方式使用的向量可以被可视化为箭头。">向量</abbr> viewUp 在视图中指向上方。当然，也可以通过从单位矩阵开始并应用平移和一些旋转来创建视图矩阵。例如，</p>
<div class="highlight"><pre><span></span><code><span class="nx">modelview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">identity</span><span class="p">();</span>
<span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="o">-</span><span class="mf">10</span><span class="p">],</span><span class="w"> </span><span class="nx">modelview</span><span class="p">);</span>
<span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">rotateX</span><span class="p">(</span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">12</span><span class="p">,</span><span class="w"> </span><span class="nx">modelview</span><span class="p">);</span>
<span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">rotateY</span><span class="p">(</span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">15</span><span class="p">,</span><span class="w"> </span><span class="nx">modelview</span><span class="p">);</span>
</code></pre></div>
<p>（我将指出，然而，在我的本节示例程序中，视图矩阵实际上来自于我与 <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr> 一起使用的相同的“trackball rotator”。见 <a href="../../c7/s1/#715-鼠标旋转">7.1.5小节</a>。）</p>
<p>对于将建模变换应用于模型视图矩阵，wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 有以下函数，我在这里包括了可选的最后一个参数，并显示了数组形式的向量参数：</p>
<ul>
<li>gpuMatrix.mat4.scale(modelview, [sx,sy,sz], modelview) — 按 x 方向的 sx 因子，y 方向的 sy 因子，和 z 方向的 sz 因子进行缩放。</li>
<li>gpuMatrix.mat4.axisRotate(modelview, [ax,ay,az], angle, modelview) — 绕通过 [0,0,0] 和 [ax,ay,az] 的直线旋转 angle 弧度。（注意，所有旋转都使用右手规则。）</li>
<li>gpuMatrix.mat4.rotateX(modelview, angle, modelview) — 绕 x 轴旋转 angle 弧度。</li>
<li>gpuMatrix.mat4.rotateY(modelview, angle, modelview) — 绕 y 轴旋转 angle 弧度。</li>
<li>gpuMatrix.mat4.rotateZ(modelview, angle, modelview) — 绕 z 轴旋转 angle 弧度。</li>
<li>gpuMatrix.mat4.translate(modelview, [tx,ty,tz], modelview) — 按 x 方向的 tx 距离，y 方向的 ty 距离，和 z 方向的 tz 距离进行平移。</li>
</ul>
<p>法向量矩阵，用于变换法向量，是一个 3x3 <abbr title="数字的矩形数组。矩阵可以表示为二维数组，数字按行和列排列。一个N×N矩阵表示从N维空间到自身的线性变换。">矩阵</abbr>。它可以通过取 4x4 模型视图矩阵的左上角 3x3 子矩阵，然后取该矩阵的转置的逆来从模型视图矩阵导出。在 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 中，可以这样做：</p>
<div class="highlight"><pre><span></span><code><span class="nx">normalMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mat3</span><span class="p">.</span><span class="nx">fromMat4</span><span class="p">(</span><span class="nx">modelview</span><span class="p">);</span><span class="w"> </span>
<span class="nx">mat3</span><span class="p">.</span><span class="nx">transpose</span><span class="p">(</span><span class="nx">normalMatrix</span><span class="p">,</span><span class="nx">normalMatrix</span><span class="p">)</span>
<span class="nx">mat3</span><span class="p">.</span><span class="nx">inverse</span><span class="p">(</span><span class="nx">normalMatrix</span><span class="p">,</span><span class="nx">normalMatrix</span><span class="p">);</span>
</code></pre></div>
<p>（如果模型视图矩阵不包括任何缩放操作，那么取逆和转置是不必要的。）</p>
<p>还有函数用于将向量 V 乘以矩阵 M。对于 4 维向量和 4x4 <abbr title="数字的矩形数组。矩阵可以表示为二维数组，数字按行和列排列。一个N×N矩阵表示从N维空间到自身的线性变换。">矩阵</abbr>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">transformedV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">vec4</span><span class="p">.</span><span class="nx">transformMat4</span><span class="p">(</span><span class="w"> </span><span class="nx">V</span><span class="p">,</span><span class="w"> </span><span class="nx">M</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>以及对于 3 维向量和 3x3 矩阵的类似函数。</p>
</div>
<div class="tabbed-block">
<p>We need to work with matrices and vectors on the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> side of a program. For that, it is convenient to use a <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> library that supports <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> and <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> math. For <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr>, we used <abbr title="一个用于二维和三维向量和矩阵数学的开源JavaScript库。">glMatrix</abbr> (<a href="../../c7/s1/#712-glmatrix简介">Subsection 7.1.2</a>). For <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr>, we need a different library, for several reasons. One reason is that the range for z in <abbr title="The default coordinate system in OpenGL. The projection transform maps the 3D scene to clip coordinates. The rendered image will show the contents of the cube in the clip coordinate system that contains x, y, and z values in the range from -1 to 1; anything outside that range is &quot;clipped&quot; away.">clip coordinates</abbr> in <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> is from 0 to 1 while in <abbr title="OpenGL Shader Language, the programming language that is used to write shader programs for use with OpenGL.">GLSL</abbr>, the range is from -1 to 1. This means that <abbr title="A transformation that maps coordinates in 3D to coordinates in 2D. Projection is used to convert a three-dimensional scene into a two-dimensional image.">projection</abbr> matrices will be different in the two shading languages. A second reason is that a 3-by-3 <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> in <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> contains 12 floats, because of alignment issues (<a href="../s3/#931-地址空间和对齐">Subsection 9.3.1</a>), while in <abbr title="OpenGL Shader Language, the programming language that is used to write shader programs for use with OpenGL.">GLSL</abbr>, a 3-by-3 <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> contains 9 floats.</p>
<p>In my examples, I use the wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> library (<a href="../../../en/source/webgpu/wgpu-matrix.js">webgpu/wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.js</a>), by Gregg Tavares, which is distributed under the MIT open source license. Download and documentation links can be found on its web page, <a href="https://wgpu-matrix.org/">https://wgpu-matrix.org/</a>. (Some of my examples use the smaller, "minified," version of the library, <a href="../../../en/source/webgpu/wgpu-matrix.min.js">webgpu/wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.min.js</a>, which is not human-readable.) I found the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> files in the "dist" folder in the wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> download.</p>
<p>The <abbr title="In OpenGL 1.1, a transform that combines the modeling transform with the viewing transform. That is, it is the composition of the transformation from object coordinates to world coordinates and the transformation from world coordinates to eye coordinates. Because of the equivalence between modeling and viewing transformations, world coordinates are not really meaningful for OpenGL, and only the combined transformation is tracked.">modelview transformation</abbr> <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> can be computed on the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> side by starting with the <abbr title="The n-by-n identity matrix is an n-by-n matrix which has ones on the diagonal and zeros elsewhere. Multiplication of any matrix B by the identity matrix, in either order, leaves B unchanged. Multiplication of an n-dimensional vector by the n-by-n identity matrix leaves the vector unchanged; that is, the identity matrix is the matrix for the identity transformation.">identity matrix</abbr> and then multiplying by <abbr title="Setting the position and orientation of the viewer in a 3D world, which determine what will be visible when the 2D image of a 3D world is rendered.">viewing</abbr> and modeling transformations that are given by <abbr title="A geometric transform that multiplies each coordinate of a point by a number called the scaling factor. Scaling increases or decreases the size of an object, but also moves its points closer to or farther from the origin. Scaling can be uniform—the same in every direction—or non-uniform—with a different scaling factor in each coordinate direction. A negative scaling factor can be used to apply a reflection.">scaling</abbr>, <abbr title="A geometric transform that rotates each point by a specified angle about some point (in 2D) or axis (in 3D).">rotation</abbr>, and <abbr title="A geometric transform that adds a given translation amount to each coordinate of a point. Translation is used to move objects without changing their size or orientation.">translation</abbr>. There are several familiar ways to construct orthographic and <abbr title="A projection from 3D to 2D that projects objects along lines radiating out from a viewpoint. A perspective projection attempts to simulate realistic viewing. A perspective projection preserves perspective; that is, objects that are farther from the viewpoint are smaller in the projection. In OpenGL 1.1, the view volume for a perspective projection is a frustum, or truncated pyramid.">perspective projection</abbr> matrices (see <a href="../../c3/s3/#333-投影变换">Subsection 3.3.3</a>). All of this is easily implemented using wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.</p>
<p>In wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.js, the <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> and math functions are properties of objects such as wgpuMatrix.mat4, wgpuMatrix.mat3, and wgpuMatrix.vec4. Matrices and vectors are represented as Float32Arrays with the appropriate lengths. They can be created as <strong><em>Float32Arrays</em></strong> directly or by calling functions from the library; for example:</p>
<div class="highlight"><pre><span></span><code><span class="nx">matrix4</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span><span class="w">  </span><span class="c1">// a 4-by-4 matrix</span>
<span class="nx">vector3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">vec3</span><span class="p">.</span><span class="nx">create</span><span class="p">();</span><span class="w">  </span><span class="c1">// a 3-vector</span>
</code></pre></div>
<p>These functions create arrays filled with zeros. Most <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> and <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> operations produce a <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> or <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> as output. In wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, you can usually pass an existing <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> or <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> as the final parameter to a function, to receive the output. However, that parameter is optional, and the library will create a new <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> or <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> for the output, if none is provided. In any case, the output is the return value of the function. For example, if modelview is the current modelview <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, and if you want to apply a <abbr title="A geometric transform that adds a given translation amount to each coordinate of a point. Translation is used to move objects without changing their size or orientation.">translation</abbr> by [3,6,4], you can say either</p>
<div class="highlight"><pre><span></span><code><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="w"> </span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">4</span><span class="p">],</span><span class="w"> </span><span class="nx">modelview</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>or</p>
<div class="highlight"><pre><span></span><code><span class="nx">modelview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="w"> </span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">3</span><span class="p">,</span><span class="mf">6</span><span class="p">,</span><span class="mf">4</span><span class="p">]</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>The first version is, of course, more efficient.</p>
<p>Lets look at some of the most important functions from wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.js. This will include all of the functions that are used in my examples. For creating a <abbr title="A transformation that maps coordinates in 3D to coordinates in 2D. Projection is used to convert a three-dimensional scene into a two-dimensional image.">projection</abbr> <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, the most common approach is</p>
<div class="highlight"><pre><span></span><code><span class="nx">projMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">perspective</span><span class="p">(</span><span class="w"> </span><span class="nx">fovy</span><span class="p">,</span><span class="w"> </span><span class="nx">aspect</span><span class="p">,</span><span class="w"> </span><span class="nx">near</span><span class="p">,</span><span class="w"> </span><span class="nx">far</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>where fovy is the vertical field of view angle, given in radians, aspect is the ratio of the width of the image to its height, near is the distance of the near clipping plane from the viewer, and far is the distance of the far clipping plane. This is essentially the same as the gluPerspective() function in <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr> (<a href="../../c3/s3/#333-投影变换">Subsection 3.3.3</a>) except for measuring the angle in radians instead of degrees. Equivalents of glOrtho() and glFrustum() are also available in wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.</p>
<p>For the modelview <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, it is usual to start with a <abbr title="Setting the position and orientation of the viewer in a 3D world, which determine what will be visible when the 2D image of a 3D world is rendered.">viewing</abbr> transformation. For that, the equivalent of gluLookAt() is convenient:</p>
<div class="highlight"><pre><span></span><code><span class="nx">modelview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span><span class="w"> </span><span class="nx">eye</span><span class="p">,</span><span class="w"> </span><span class="nx">viewRef</span><span class="p">,</span><span class="w"> </span><span class="nx">viewUp</span><span class="w"> </span><span class="p">)</span>
</code></pre></div>
<p>The parameters are 3-vectors, which can be specified as regular <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> arrays. This constructs a view <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> for a viewer positioned at eye, looking in the direction of viewRef, with the <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> viewUp pointing upwards in the view. Of course, a view <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> might also be created by starting with the <abbr title="The n-by-n identity matrix is an n-by-n matrix which has ones on the diagonal and zeros elsewhere. Multiplication of any matrix B by the identity matrix, in either order, leaves B unchanged. Multiplication of an n-dimensional vector by the n-by-n identity matrix leaves the vector unchanged; that is, the identity matrix is the matrix for the identity transformation.">identity matrix</abbr> and applying a <abbr title="A geometric transform that adds a given translation amount to each coordinate of a point. Translation is used to move objects without changing their size or orientation.">translation</abbr> and some rotations. For example,</p>
<div class="highlight"><pre><span></span><code><span class="nx">modelview</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">gpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">identity</span><span class="p">();</span>
<span class="nx">gpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">translate</span><span class="p">(</span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="mf">0</span><span class="p">,</span><span class="mf">0</span><span class="p">,</span><span class="o">-</span><span class="mf">10</span><span class="p">],</span><span class="w"> </span><span class="nx">modelview</span><span class="p">);</span>
<span class="nx">gpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">rotateX</span><span class="p">(</span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">12</span><span class="p">,</span><span class="w"> </span><span class="nx">modelview</span><span class="p">);</span>
<span class="nx">gpuMatrix</span><span class="p">.</span><span class="nx">mat4</span><span class="p">.</span><span class="nx">rotateY</span><span class="p">(</span><span class="nx">modelview</span><span class="p">,</span><span class="w"> </span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mf">15</span><span class="p">,</span><span class="w"> </span><span class="nx">modelview</span><span class="p">);</span>
</code></pre></div>
<p>(I will note, however, that in my sample programs for this section, the view <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> actually comes the same "trackball rotator" that I used with <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr>. See <a href="../../c7/s1/#715-鼠标旋转">Subsection 7.1.5</a>.)</p>
<p>For applying modeling transformations to the modelview <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> has the following functions, where I am including the optional final parameter and showing <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> parameters as arrays:</p>
<ul>
<li>gpuMatrix.mat4.scale(modelview, [sx,sy,sz], modelview) — scales by a factor of sx in the x direction, sy in the y direction, and sz in the z direction.</li>
<li>gpuMatrix.mat4.axisRotate(modelview, [ax,ay,az], angle, modelview) — rotates by angle radians about the line through [0,0,0] and [ax,ay,az]. (Note that all rotations use the <abbr title="A rule that is used to determine the positive direction of rotation about an axis in 3D space: If you point the thumb of your right hand in the direction of the axis, then your fingers will curl in the direction of positive angles of rotation. Note that this assumes that the axis has a direction; in OpenGL, an axis of rotation is determined by the point (0,0,0) and another point (x,y,z), and the direction of the axis is from (0,0,0) towards (x,y,z).">right-hand rule</abbr>.)</li>
<li>gpuMatrix.mat4.rotateX(modelview, angle, modelview) — rotates by angle radians about the x-axis.</li>
<li>gpuMatrix.mat4.rotateY(modelview, angle, modelview) — rotates by angle radians about the y-axis.</li>
<li>gpuMatrix.mat4.rotateZ(modelview, angle, modelview) — rotates by angle radians about the z-axis.</li>
<li>gpuMatrix.mat4.translate(modelview, [tx,ty,tz], modelview) — translates by a distance of tx in the x direction, ty in the y direction, and tz in the z direction.</li>
</ul>
<p>The normal <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, which is used to transform normal vectors, is a 3-by-3 <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>. It can be derived from the modelview <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> by taking the upper-left 3-by-3 submatrix of the 4-by-4 modelview <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, and then taking the inverse of the transpose of that <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>. In wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, that can be done as follows:</p>
<div class="highlight"><pre><span></span><code><span class="nx">normalMatrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">mat3</span><span class="p">.</span><span class="nx">fromMat4</span><span class="p">(</span><span class="nx">modelview</span><span class="p">);</span><span class="w"> </span>
<span class="nx">mat3</span><span class="p">.</span><span class="nx">transpose</span><span class="p">(</span><span class="nx">normalMatrix</span><span class="p">,</span><span class="nx">normalMatrix</span><span class="p">)</span>
<span class="nx">mat3</span><span class="p">.</span><span class="nx">inverse</span><span class="p">(</span><span class="nx">normalMatrix</span><span class="p">,</span><span class="nx">normalMatrix</span><span class="p">);</span>
</code></pre></div>
<p>(If the modelview <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> does not include any <abbr title="A geometric transform that multiplies each coordinate of a point by a number called the scaling factor. Scaling increases or decreases the size of an object, but also moves its points closer to or farther from the origin. Scaling can be uniform—the same in every direction—or non-uniform—with a different scaling factor in each coordinate direction. A negative scaling factor can be used to apply a reflection.">scaling</abbr> operations, then taking the inverse and transpose is unnecessary.)</p>
<p>There are also functions for multiplying a <abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr>, V, by a <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>, M. For a 4-<abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> and a 4-by-4 <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">transformedV</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">wgpuMatrix</span><span class="p">.</span><span class="nx">vec4</span><span class="p">.</span><span class="nx">transformMat4</span><span class="p">(</span><span class="w"> </span><span class="nx">V</span><span class="p">,</span><span class="w"> </span><span class="nx">M</span><span class="w"> </span><span class="p">);</span>
</code></pre></div>
<p>and similarly for a 3-<abbr title="An element of a vector space. Elements of a vector space can be added and can be multiplied by constants. For computer graphics, a vector is just a list or array containing two, three, or four numbers. Vectors in that sense are often used to represent points in 2D, 3D, or 4D space. Properly, however, a vector represents a quantity that has a length and a direction; a vector used in this way can be visualized as an arrow.">vector</abbr> and a 3-by-3 <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr>.</p>
</div>
</div>
</div>
<h2 id="945-再次磁盘世界">9.4.5 再次磁盘世界<a class="headerlink" href="#945-再次磁盘世界" title="Permanent link">&para;</a></h2>
<p><strong>Diskworld Yet Again</strong></p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="__tabbed_6_1">中文</label><label for="__tabbed_6_2">英文</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<p><a href="../../c7/s2/">第7.2节</a> 涵盖了在 <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr> 中实现 <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr> 风格光照和材质的方法，包括漫反射、镜面反射和自发光材质属性，定向光和点光源，聚光灯和光照衰减。该节最后的“Diskworld 2”示例展示了所有这些属性。</p>
<p>示例程序 <a href="../../../en/source/webgpu/diskworld_webgpu.html">webgpu/diskworld_webgpu.html</a> 是将 Diskworld 2 示例移植到 <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> 的功能相同的版本。<abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> 版本的顶点着色器本质上与上面讨论的 <a href="../../../en/source/webgpu/Phong_lighting.html">Phong 光照示例</a> 中的相同。片段着色器本质上与 <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr> 版本相同，除了变量和函数声明的语法以及一些类型的重命名。程序的 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 端使用层次建模来创建场景（见 <a href="../../c3/s2/#323-层次建模">3.2.3小节</a>），变换使用 wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> 库实现。基本对象，如圆柱体和球体，被创建为索引面集。每个对象有三个关联的缓冲区：一个包含 3D 顶点坐标的顶点缓冲区，一个包含法向量的顶点缓冲区，以及一个索引缓冲区。当渲染对象时，其缓冲区被附加到渲染管线。程序使用深度测试（显然！）和多重采样。值得查看源代码，但我将不详细讨论。然而，我们将简要看看片段着色器如何实现光照方程。光和材质属性以及法向量矩阵是片段着色器中的 uniform 变量：</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">MaterialProperties</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">diffuseColor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec4f</span><span class="p">,</span><span class="w"> </span><span class="c1">// alpha 分量成为片段的 alpha</span>
<span class="w">    </span><span class="nl">specularColor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">emissiveColor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">specularExponent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">f32</span>
<span class="p">}</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">LightProperties</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">position</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec4f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">color</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">spotDirection</span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span><span class="w">  </span><span class="c1">// 注意：只有点光源可以是聚光灯。</span>
<span class="w">    </span><span class="nl">spotCosineCutoff</span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="p">,</span><span class="w"> </span><span class="c1">// 如果 &lt;= 0，则不是聚光灯。</span>
<span class="w">    </span><span class="nl">spotExponent</span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="p">,</span>
<span class="w">    </span><span class="nl">attenuation</span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="p">,</span><span class="w">   </span><span class="c1">// 线性衰减因子，&gt;= 0（仅限点光源）。</span>
<span class="w">    </span><span class="nl">enabled</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="w">  </span><span class="c1">// 0.0 或 1.0 表示 false/true</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">binding</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="o">&lt;</span><span class="n">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MaterialProperties</span><span class="p">;</span>
<span class="err">@</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">binding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="o">&lt;</span><span class="n">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lights</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">LightProperties</span><span class="p">,</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span>
<span class="err">@</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">binding</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="o">&lt;</span><span class="n">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="n">normalMatrix</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mat3x3f</span><span class="p">;</span>
</code></pre></div>
<p>所有这些值都在同一个 uniform 缓冲区中。请注意，由于 uniform 的对齐要求（见 <a href="../s3/#931-地址空间和对齐">9.3.1小节</a>），光属性在缓冲区中的偏移是 256 字节，法向量矩阵是 512 字节。（但这是 <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> 端的信息）。</p>
<p>光照方程由以下函数实现，该函数由片段着色器入口点函数为每个启用的光源调用：</p>
<div class="highlight"><pre><span></span><code><span class="nx">fn</span><span class="w"> </span><span class="nx">lightingEquation</span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="o">:</span><span class="w"> </span><span class="nx">LightProperties</span><span class="p">,</span><span class="w"> </span><span class="nx">material</span><span class="o">:</span><span class="w"> </span><span class="nx">MaterialProperties</span><span class="p">,</span>
<span class="w">                    </span><span class="nx">eyeCoords</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w"> </span><span class="nx">N</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w"> </span><span class="nx">V</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">vec3f</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// N 是法向量，V 是指向观察者的方向；它们都是单位向量。</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">L</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">;</span><span class="w">  </span><span class="c1">// 指向光源的单位向量</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">R</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">;</span><span class="w">  </span><span class="c1">// 反射光方向；通过 N 反射 -L</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">spotFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w">  </span><span class="c1">// 考虑聚光灯的乘数</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">attenuationFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 考虑光衰减的乘数</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 定向光。</span>
<span class="w">        </span><span class="nx">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">xyz</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 点光源。</span>
<span class="w">        </span><span class="c1">// 只有点光源可能有聚光灯和衰减。</span>
<span class="w">        </span><span class="nx">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">xyz</span><span class="o">/</span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">light</span><span class="p">.</span><span class="nx">spotCosineCutoff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 光源是聚光灯。</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">light</span><span class="p">.</span><span class="nx">spotDirection</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">spotCosine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dot</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span><span class="nx">L</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">spotCosine</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">spotCosineCutoff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="nx">spotFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pow</span><span class="p">(</span><span class="nx">spotCosine</span><span class="p">,</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">spotExponent</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 该点在聚光灯的光锥之外。</span>
<span class="w">                </span><span class="nx">spotFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// 光不会对该点添加颜色。</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">light</span><span class="p">.</span><span class="nx">attenuation</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">distance</span><span class="p">(</span><span class="nx">eyeCoords</span><span class="p">,</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">xyz</span><span class="o">/</span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">w</span><span class="p">);</span>
<span class="w">            </span><span class="nx">attenuationFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dist</span><span class="o">*</span><span class="nx">light</span><span class="p">.</span><span class="nx">attenuation</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="nx">L</span><span class="p">,</span><span class="nx">N</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 光没有照亮这一面。</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">reflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dot</span><span class="p">(</span><span class="nx">L</span><span class="p">,</span><span class="nx">N</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">color</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">material</span><span class="p">.</span><span class="nx">diffuseColor</span><span class="p">.</span><span class="nx">rgb</span><span class="p">;</span>
<span class="w">    </span><span class="nx">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">reflect</span><span class="p">(</span><span class="nx">L</span><span class="p">,</span><span class="nx">N</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="nx">R</span><span class="p">,</span><span class="nx">V</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 添加镜面反射。</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pow</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="nx">R</span><span class="p">,</span><span class="nx">V</span><span class="p">),</span><span class="w"> </span><span class="nx">material</span><span class="p">.</span><span class="nx">specularExponent</span><span class="p">);</span>
<span class="w">        </span><span class="nx">reflection</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">factor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">material</span><span class="p">.</span><span class="nx">specularColor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">spotFactor</span><span class="o">*</span><span class="nx">attenuationFactor</span><span class="o">*</span><span class="nx">reflection</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>返回值表示光源对片段颜色的贡献。可能光源实际上照射在正在渲染的图元的另一侧（“dot(L,N) &lt;= 0.0”），在这种情况下，它不会对颜色做出贡献。否则，贡献被计算为漫反射和镜面反射的总和，乘以考虑聚光灯和光衰减的因子。如果光不是聚光灯，相应的因子是 1.0，对返回值没有影响。对于聚光灯，因子取决于片段在聚光灯锥体内的哪个位置。这里使用的光衰减因子称为“线性衰减”。它在物理上不真实，但经常使用，因为它可以比物理真实的衰减提供更好的视觉效果。我鼓励你阅读代码，作为一个 <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> 编程的例子，并在你对光照模型有疑问时参考 <a href="../../c7/s2/">第7.2节</a>。</p>
</div>
<div class="tabbed-block">
<p><a href="../../c7/s2/">Section 7.2</a> covered the implementation of <abbr title="A family of computer graphics APIs that is implemented in many graphics hardware devices. There are several versions of the API, and there are implementations, or &quot;bindings&quot; for several different programming languages. Versions of OpenGL for embedded systems such as mobile phones are known as OpenGL ES. WebGL is a version for use on Web pages. OpenGL can be used for 2D as well as for 3D graphics, but it is most commonly associated with 3D.">OpenGL</abbr>-style <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> and materials in <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr>, including diffuse, specular, and emissive <abbr title="The properties of an object that determine how that object interacts with light in the environment. Material properties in OpenGL include, for example, diffuse color, specular color, and shininess.">material</abbr> properties, directional and point lights, spotlights, and light <abbr title="Refers to the way that illumination from a point light or spot light decreases with distance from the light. Physically, illumination should decrease with the square of the distance, but computer graphics often uses a linear attenuation with distance, or no attenuation at at all.">attenuation</abbr>. The "Diskworld 2" example at the end of that section illustrated all of these properties.</p>
<p>The sample program <a href="../../../en/source/webgpu/diskworld_webgpu.html">webgpu/diskworld_webgpu.html</a> is a functionally identical port of the Diskworld 2 example to <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr>. The <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> <abbr title="A program to be executed at some stage of the rendering pipeline. OpenGL shaders are written in the GLSL programming languages. For WebGL, only vertex shaders and fragment shaders are supported. WebGPU also has compute shaders, which are used in compute pipelines.">shader</abbr> in the <abbr title="一种新的 JavaScript 图形 API，类似于 WebGL，但设计用于让网络程序访问现代 GPU 功能，如计算着色器。">WebGPU</abbr> version is essentially the same as that in the <a href="../../../en/source/webgpu/Phong_lighting.html">Phong <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> example</a> that was discussed above. The <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr> is essentially the same as the <abbr title="A 3D graphics API for use on web pages. WebGL programs are written in the JavaScript programming language and display their images in HTML canvas elements. WebGL is based on OpenGL ES, the version of OpenGL for embedded systems, with a few changes to adapt it to the JavaScript language and the Web environment.">WebGL</abbr> version, except for the syntax of variable and function declarations and some renaming of types. The <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> side of the program uses <abbr title="Creating complex geometric models in a hierarchical fashion, starting with geometric primitives, combining them into components that can then be further combined into more complex components, and so on.">hierarchical modeling</abbr> to create the scene (<a href="../../c3/s2/#323-层次建模">Subsection 3.2.3</a>), with transformations implemented using the wgpu-<abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> library. The basic objects, such as cylinders and spheres, are created as indexed face sets. Each object has three associated buffers: a <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> buffer containing the 3D <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> coordinates, a <abbr title="One of the points that define a geometric primitive, such as the two endpoints of a line segment or the three vertices of a triangle. (The plural is &quot;vertices.&quot;) A vertex can be specified in a coordinate system by giving its x and y coordinates in 2D graphics, or its x, y, and z coordinates in 3D graphics.">vertex</abbr> buffer containing the normal vectors, and an <abbr title="In WebGPU, an index buffer is a GPU buffer that holds vertex indices for use with the drawIndexed(). A vertex index gives the position of a vertex in the list of vertices of a primitive.">index buffer</abbr>. When an object is rendered, its buffers are attached to the render <abbr title="A sequence of computational stages in a GPU that are applied to incoming data to produce some result. Some of the stages can be programmable shaders, such as vertex shaders, fragment shaders, and compute shaders. In a graphics rendering pipeline, the output is the colors of the pixels in an image.">pipeline</abbr>. The program uses the <abbr title="A solution to the hidden surface problem that involves keeping track of the depth, or distance from the viewer, of the object currently visible at each pixel in the image. When a new object is drawn at a pixel, the depth of the new object is compared to the depth of the current object to decide which one is closer to the viewer. The advantage of the depth test is that objects can be rendered in any order. A disadvantage is that only a limited range of depths can be represented in the image.">depth test</abbr> (obviously!) and <abbr title="A kind of antialiasing where the fragment shader is evaluated at several points in each pixel, and the results are averaged to get the color of the pixel.">multisampling</abbr>. It is worth looking at the source code, but I will not discuss it in detail. However, we will look briefly at how the <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr> implements the <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> equation. The light and <abbr title="The properties of an object that determine how that object interacts with light in the environment. Material properties in OpenGL include, for example, diffuse color, specular color, and shininess.">material</abbr> properties and the normal <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> are uniform variables in the <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr>:</p>
<div class="highlight"><pre><span></span><code><span class="k">struct</span><span class="w"> </span><span class="nc">MaterialProperties</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">diffuseColor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec4f</span><span class="p">,</span><span class="w"> </span><span class="c1">// alpha component becomes the alpha for the fragment</span>
<span class="w">    </span><span class="nl">specularColor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">emissiveColor</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">specularExponent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">f32</span>
<span class="p">}</span>

<span class="k">struct</span><span class="w"> </span><span class="nc">LightProperties</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nl">position</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec4f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">color</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span>
<span class="w">    </span><span class="nl">spotDirection</span><span class="p">:</span><span class="w"> </span><span class="n">vec3f</span><span class="p">,</span><span class="w">  </span><span class="c1">// Note: only a point light can be a spotlight.</span>
<span class="w">    </span><span class="nl">spotCosineCutoff</span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="p">,</span><span class="w"> </span><span class="c1">// If &lt;= 0, not a spotlight.</span>
<span class="w">    </span><span class="nl">spotExponent</span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="p">,</span>
<span class="w">    </span><span class="nl">attenuation</span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="p">,</span><span class="w">   </span><span class="c1">// Linear attenuation factor, &gt;= 0 (point lights only).</span>
<span class="w">    </span><span class="nl">enabled</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">f32</span><span class="w">  </span><span class="c1">// 0.0 or 1.0 for false/true</span>
<span class="p">}</span>

<span class="err">@</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">binding</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="o">&lt;</span><span class="n">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="n">material</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">MaterialProperties</span><span class="p">;</span>
<span class="err">@</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">binding</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="o">&lt;</span><span class="n">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lights</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">array</span><span class="o">&lt;</span><span class="n">LightProperties</span><span class="p">,</span><span class="mi">4</span><span class="o">&gt;</span><span class="p">;</span>
<span class="err">@</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="err">@</span><span class="n">binding</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="n">var</span><span class="o">&lt;</span><span class="n">uniform</span><span class="o">&gt;</span><span class="w"> </span><span class="n">normalMatrix</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">mat3x3f</span><span class="p">;</span>
</code></pre></div>
<p>All of these values are in the same uniform buffer. Note that because of alignment requirements for uniforms (<a href="../s3/#931-地址空间和对齐">Subsection 9.3.1</a>), the light properties are at offset 256 bytes in the buffer, and the normal <abbr title="A rectangular array of numbers. A matrix can be represented as a two-dimensional array, with numbers arranged in rows and columns. An N-by-N matrix represents a linear transformation from N-dimensional space to itself.">matrix</abbr> is at offset 512. (But that's information for the <abbr title="A programming language for web pages. JavaScript code on a web page is executed by a web browser that displays the page, and it can interact with the contents of the web page and with the user. There are JavaScript APIs for 2D and for 3D graphics">JavaScript</abbr> side.)</p>
<p>The <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> equation is implemented by the following function, which is called by the <abbr title="A shader program that will be executed once for each pixel in a primitive. A fragment shader must compute a color for the pixel, or discard it. Fragment shaders are also called pixel shaders.">fragment shader</abbr> entry point function for each enabled light:</p>
<div class="highlight"><pre><span></span><code><span class="nx">fn</span><span class="w"> </span><span class="nx">lightingEquation</span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="o">:</span><span class="w"> </span><span class="nx">LightProperties</span><span class="p">,</span><span class="w"> </span><span class="nx">material</span><span class="o">:</span><span class="w"> </span><span class="nx">MaterialProperties</span><span class="p">,</span>
<span class="w">                            </span><span class="nx">eyeCoords</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w"> </span><span class="nx">N</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">,</span><span class="w"> </span><span class="nx">V</span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">vec3f</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// N is normal vector, V is direction to viewer; both are unit vectors.</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">L</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">;</span><span class="w">  </span><span class="c1">// unit vector pointing towards the light</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">R</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">;</span><span class="w">  </span><span class="c1">// reflected light direction; reflection of -L through N</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">spotFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w">  </span><span class="c1">// multiplier to account for spotlight</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">attenuationFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// multiplier to account for light attenuation</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Directional light.</span>
<span class="w">        </span><span class="nx">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">xyz</span><span class="w"> </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Point light.</span>
<span class="w">        </span><span class="c1">// Spotlights and attenuation are possible only for point lights.</span>
<span class="w">        </span><span class="nx">L</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">normalize</span><span class="p">(</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">xyz</span><span class="o">/</span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">w</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">eyeCoords</span><span class="w"> </span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">light</span><span class="p">.</span><span class="nx">spotCosineCutoff</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// The light is a spotlight.</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">D</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">normalize</span><span class="p">(</span><span class="nx">light</span><span class="p">.</span><span class="nx">spotDirection</span><span class="p">);</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">spotCosine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dot</span><span class="p">(</span><span class="nx">D</span><span class="p">,</span><span class="nx">L</span><span class="p">);</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">spotCosine</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">spotCosineCutoff</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span>
<span class="w">                </span><span class="nx">spotFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pow</span><span class="p">(</span><span class="nx">spotCosine</span><span class="p">,</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">spotExponent</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// The point is outside the cone of light from the spotlight.</span>
<span class="w">                </span><span class="nx">spotFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span><span class="w"> </span><span class="c1">// The light will add no color to the point.</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">light</span><span class="p">.</span><span class="nx">attenuation</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">distance</span><span class="p">(</span><span class="nx">eyeCoords</span><span class="p">,</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">xyz</span><span class="o">/</span><span class="nx">light</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">w</span><span class="p">);</span>
<span class="w">            </span><span class="nx">attenuationFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">dist</span><span class="o">*</span><span class="nx">light</span><span class="p">.</span><span class="nx">attenuation</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="nx">L</span><span class="p">,</span><span class="nx">N</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Light does not illuminate this side.</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">vec3f</span><span class="p">(</span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">reflection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">dot</span><span class="p">(</span><span class="nx">L</span><span class="p">,</span><span class="nx">N</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">color</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">material</span><span class="p">.</span><span class="nx">diffuseColor</span><span class="p">.</span><span class="nx">rgb</span><span class="p">;</span>
<span class="w">    </span><span class="nx">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nx">reflect</span><span class="p">(</span><span class="nx">L</span><span class="p">,</span><span class="nx">N</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="nx">R</span><span class="p">,</span><span class="nx">V</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// Add in specular reflection.</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="nx">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pow</span><span class="p">(</span><span class="nx">dot</span><span class="p">(</span><span class="nx">R</span><span class="p">,</span><span class="nx">V</span><span class="p">),</span><span class="w"> </span><span class="nx">material</span><span class="p">.</span><span class="nx">specularExponent</span><span class="p">);</span>
<span class="w">        </span><span class="nx">reflection</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="nx">factor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">material</span><span class="p">.</span><span class="nx">specularColor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">light</span><span class="p">.</span><span class="nx">color</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">spotFactor</span><span class="o">*</span><span class="nx">attenuationFactor</span><span class="o">*</span><span class="nx">reflection</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>The return value represents the contribution of the light to the color of the fragment. It is possible that the light is actually shining on the other side of the primitive that is being rendered ("dot(L,N) &lt;= 0.0"), in which case there is no contribution to the color. Otherwise, the contribution is computed as the sum of the diffuse and <abbr title="Mirror-like reflection of light rays from a surface. A ray of light is reflected as a ray in the direction that makes the angle of reflection equal to the angle of incidence. A specular reflection can only be seen by a viewer whose position lies on the path of the reflected ray.">specular reflection</abbr>, multiplied by factors that account for spotlights and light <abbr title="Refers to the way that illumination from a point light or spot light decreases with distance from the light. Physically, illumination should decrease with the square of the distance, but computer graphics often uses a linear attenuation with distance, or no attenuation at at all.">attenuation</abbr>. If the light is not a <abbr title="A light that emits a cone of illumination. A spotlight is similar to a point light in that it has a position in 3D space, and light radiates from that position. However, the light only affects objects that are in the spotlight's cone of illumination.">spotlight</abbr> the corresponding factor is 1.0 and has no effect on the return value. For a <abbr title="A light that emits a cone of illumination. A spotlight is similar to a point light in that it has a position in 3D space, and light radiates from that position. However, the light only affects objects that are in the spotlight's cone of illumination.">spotlight</abbr>, the factor depends on where in the cone of the <abbr title="A light that emits a cone of illumination. A spotlight is similar to a point light in that it has a position in 3D space, and light radiates from that position. However, the light only affects objects that are in the spotlight's cone of illumination.">spotlight</abbr> the fragment is located. The light <abbr title="Refers to the way that illumination from a point light or spot light decreases with distance from the light. Physically, illumination should decrease with the square of the distance, but computer graphics often uses a linear attenuation with distance, or no attenuation at at all.">attenuation</abbr> factor used here is called "linear <abbr title="Refers to the way that illumination from a point light or spot light decreases with distance from the light. Physically, illumination should decrease with the square of the distance, but computer graphics often uses a linear attenuation with distance, or no attenuation at at all.">attenuation</abbr>." It is not physically realistic but is often used because it can give better visual results than physically realistic <abbr title="Refers to the way that illumination from a point light or spot light decreases with distance from the light. Physically, illumination should decrease with the square of the distance, but computer graphics often uses a linear attenuation with distance, or no attenuation at at all.">attenuation</abbr>. I encourage you to read the code, as an example of <abbr title="WebGPU 着色器语言，是编写 WebGPU 使用的着色器的编程语言。">WGSL</abbr> programming, and to consult <a href="../../c7/s2/">Section 7.2</a> if you have questions about the <abbr title="Using light sources in a 3D scene, so that the appearance of objects in the scene can be computed based on the interaction of light with the objects' material properties.">lighting</abbr> model.</p>
</div>
</div>
</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="最后更新">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1-2.1-2M12.5 7v5.2l4 2.4-1 1L11 13V7h1.5M11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2v1.8Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年7月6日</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="创建日期">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3h-2Z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">2024年5月26日</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../../..", "features": ["content.code.copy", "content.tabs.link", "navigation.tabs", "navigation.tabs.sticky", "navigation.indexes", "navigation.top", "toc.follow", "content.tooltips"], "search": "../../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://unpkg.com/mermaid@9.4.0/dist/mermaid.min.js"></script>
      
    
  <script id="init-glightbox">const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body>
</html>